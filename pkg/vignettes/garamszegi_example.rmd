---
title: "Garamszegi example"
author: "Michael Li and Ben Bolker"
output:
  pdf_document: default
  mathjax: default
  html_document: null
bibliography: phyloglmm.bib
urlcolor: blue
---

We will reproduce the examples in [chapter 11](http://www.mpcm-evolution.com/practice/online-practical-material-chapter-11/chapter-11-1-simple-model-mcmcglmm) of @garamszegi2014modern using phylogenetic GLMMs based on `lme4` and `glmmTMB`. 

To fit we need a random effect in the formula that includes a `(...|phylo)` term, to build the basic random effect structure multiplied by the `phyloZ` matrix (see vignette for more details on the `phyloZ` matrix).

```{r pkgs,message=FALSE, warning=FALSE}
library(ape)
library(Matrix)
library(lme4)
library(MASS) 
library(glmmTMB)
library(coda)
library(lattice)
library(broom)
library(poorman)
```

```{r phylocode}
library("phyloglmm")
```

### Get data

From [chapter 11](http://www.mpcm-evolution.com/practice/online-practical-material-chapter-11/chapter-11-1-simple-model-mcmcglmm) of @garamszegi2014modern: data are [here](http://mpcm-evolution.com/OPM/Chapter11_OPM/data.zip)

```{r getdat}
if (!file.exists("data/phylo.nex")) {
    dir.create("data")
    download.file("http://mpcm-evolution.com/OPM/Chapter11_OPM/data.zip",
                  dest="data/OPM_ch11_data.zip")
    setwd("data")
    untar("OPM_ch11_data.zip")
    setwd("..")
}
phylo <- garamszegi_phy
```

Compute appropriate $Z$ matrix up front, to measure speed (also
reusable in a few places below):

```{r calc_phyloZ,cache=TRUE}
system.time(phyloZ <- phylo.to.Z(phylo))
```
## Result comparison with Gaussian example in chapter 11

```{r G_results}
datG <- garamszegi_simple
## create observation-level grouping variable
datG$obs <- factor(seq(nrow(datG)))
datG$sp <- datG$phylo
phylo_lmm_fit <- phylo_lmm(phen~cofactor+(1|sp)
  , data=datG
  , phylonm = "sp"
  , phylo = phylo
  , phyloZ=phyloZ
  , REML = TRUE
  , control=lmerControl(check.nobs.vs.nlev="ignore",check.nobs.vs.nRE="ignore")
)
print(summary(phylo_lmm_fit))
```

Similarly, fitting using glmmTMB:

```{r glmmTMB}
glmmTMB_fit <- glmmTMBphylo(phen~cofactor+(1|sp)
    , data=datG
    , phyloZ=phyloZ
    , phylonm = "sp"
    , doFit=TRUE
    , dispformula = ~1
    , REML = FALSE
  ) 
print(summary(glmmTMB_fit))
```


## Result comparison with Gaussian with repeated measures example in chapter 11

```{r GR_results}
datR <- garamszegi_repeat
datR$obs <- factor(seq(nrow(datR)))
datR <- (datR 
  %>% mutate(sp = factor(species)
        , animals = factor(phylo)
        )
)
datR$spec_mean_cf <- sapply(split(datR$cofactor,datR$phylo),mean)[datR$phylo]
datR$within_spec_cf <- datR$cofactor-datR$spec_mean_cf
phylo_lmm_fit <- phylo_lmm(phen~spec_mean_cf+within_spec_cf+(1|sp) + (1|animals)
  , data=datR
  , phylonm = "sp"
  , phylo = phylo
  , phyloZ=phyloZ
  , REML = FALSE
  , control=lmerControl(check.nobs.vs.nlev="ignore",check.nobs.vs.nRE="ignore")
)
             
print(summary(phylo_lmm_fit))

glmmTMB_fit2 <- glmmTMBphylo(phen~spec_mean_cf+within_spec_cf+(1|sp) + (1|animals)
    , data=datR
    , phyloZ=phyloZ
    , phylonm = "sp"
    , doFit=TRUE
    , dispformula = ~1
    , REML = FALSE
  ) 
print(summary(glmmTMB_fit2))


```

## Result comparison with non-Gaussian example in chapter 11

```{r P_results}
dat <- garamszegi_pois
dat$obs <- factor(seq(nrow(dat)))


dat <- dat %>% mutate(sp=factor(phylo)) 
phylo_glmm_fit <- phylo_glmm(phen_pois~cofactor+(1|sp)+(1|obs)
  , data=dat
  , phylonm = "sp"
  , family = poisson
  , phylo = phylo
  , phyloZ=phyloZ
  , control=lmerControl(check.nobs.vs.nlev="ignore",check.nobs.vs.nRE="ignore")
)

summary(phylo_glmm_fit)

glmmTMB_fit3 <- glmmTMBphylo(phen_pois~cofactor+(1|sp)+(1|obs)
    , data=dat
    , family = poisson
    , phyloZ=phyloZ
    , phylonm = "sp"
    , doFit=TRUE
    , dispformula = ~1
    , REML = FALSE
  ) 
print(summary(glmmTMB_fit3))

print(packageVersion("glmmTMB"))
print(packageVersion("lme4"))

```


## References
